<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Studio Delta</title>
  
  <!-- Fonts & Bootstrap -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    :root { 
      --sd-bg: #EBEAE6; 
      --sd-text: #1a1a1a; 
      --sd-accent: #000000; 
      --sd-white: #ffffff;
      --sd-shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
      --sd-shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --sd-shadow-lg: 0 6px 20px rgba(0,0,0,0.12);
      --sd-transition: all 0.2s ease;
    }
    body { 
      background-color: var(--sd-bg); 
      color: var(--sd-text); 
      font-family: 'Lato', sans-serif; 
      overflow-x: hidden;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, .brand-font { 
      font-family: 'Playfair Display', serif; 
      color: var(--sd-accent);
      line-height: 1.3;
    }
    
    /* Input fields improvements */
    .form-control {
      border-radius: 8px;
      border: 2px solid #dee2e6;
      padding: 12px 16px;
      transition: var(--sd-transition);
    }
    .form-control:focus {
      border-color: var(--sd-accent);
      box-shadow: 0 0 0 0.2rem rgba(0,0,0,0.1);
    }
    
    /* Search input with icon */
    #dashSearch, #prodSearch {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 12px center;
      background-size: 16px 16px;
      padding-left: 40px;
    }
    
    /* Badge improvements */
    .badge {
      padding: 6px 12px;
      font-weight: 500;
      border-radius: 6px;
    }
    
    /* Loading spinner */
    .spinner-border {
      margin: 40px auto;
      display: block;
    }
    
/* SIDEBAR */
    .sidebar { 
        position: fixed; 
        top: 0; 
        left: 0; 
        height: 100vh; 
        width: 280px; 
        background: white; 
        z-index: 1100; 
        transform: translateX(-100%); 
        transition: transform 0.3s ease; 
        box-shadow: 2px 0 10px rgba(0,0,0,0.15); 
        padding-top: 20px; 
        overflow-y: auto;
    }
    .sidebar.active { transform: translateX(0); }
    
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .sidebar-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    /* SIDEBAR LINKS */
    .sidebar-link { 
        display: block; 
        padding: 16px 28px; 
        color: #333; 
        text-decoration: none; 
        font-weight: 500; 
        font-size: 15px;
        border-left: 4px solid transparent; 
        cursor: pointer; 
        transition: all 0.2s ease;
        margin-bottom: 4px;
    }
    .sidebar-link:hover { 
        background-color: #f5f5f5; 
        color: #000;
    }
    .sidebar-link.active { 
        background: #f8f9fa; 
        border-left-color: black;
        font-weight: 600;
    }

    /* MENU BUTTON */
    .menu-toggle { 
        position: fixed; 
        top: 20px; 
        left: 20px; 
        z-index: 1200; 
        background: white; 
        border: none; 
        padding: 12px 16px; 
        border-radius: 8px; 
        box-shadow: 0 2px 12px rgba(0,0,0,0.15); 
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .menu-toggle:hover { 
        transform: scale(1.05); 
        background: #f8f9fa;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2); 
    }

    /* WHEN MENU IS OPEN - MOVE BUTTON */
    .menu-toggle.active {
        left: 225px !important;
        background: transparent;
        box-shadow: none; 
    }

    /* MOBILE ONLY FIXES */
    @media (max-width: 768px) {
        /* Glass Header */
        body::before {
            content: '';
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 70px; 
            background: rgba(255, 255, 255, 0.97); 
            backdrop-filter: blur(8px); 
            z-index: 1050; 
            border-bottom: 1px solid #e0e0e0;
            display: block;
        }

        /* Mobile Button Position */
        .menu-toggle {
            top: 15px;
            left: 15px;
            padding: 10px 14px;
            border-radius: 8px;
        }

        /* Content spacing */
        .container-fluid { 
            padding-top: 95px !important; 
            padding-left: 15px !important;
            padding-right: 15px !important;
        }
        
        /* Sidebar width on mobile */
        .sidebar {
            width: 280px;
        }
        
        /* Card improvements on mobile */
        .card {
            margin-bottom: 16px !important;
        }
        
        .card-body {
            padding: 16px !important;
        }
        
        /* Button improvements */
        .btn {
            padding: 12px 16px !important;
            font-size: 15px !important;
        }
        
        /* Role cards on mobile */
        #roleGrid .col-md-4 {
            margin-bottom: 12px;
        }
        
        /* Improve modal spacing */
        .modal-content {
            margin: 10px;
        }
        
        .modal-dialog-centered {
            padding: 10px;
        }
        
        .modal-lg {
            max-width: calc(100% - 20px);
        }
        
        /* Better table responsiveness */
        .table-responsive {
            font-size: 14px;
        }
        
        /* QC checklist improvements */
        #qcChecklistContainer {
            max-height: 50vh;
            overflow-y: auto;
        }
    }

    @media (min-width: 769px) {
        body::before { display: none; }
        
        /* Desktop spacing */
        .container {
            max-width: 1200px;
        }
        
        /* Better card layouts */
        .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        }
    }
    
    /* BUTTONS */
    .btn-primary, .btn-primary:hover, .btn-primary:active, .btn-primary:focus {
        background-color: #000000 !important;
        border-color: #000000 !important;
        color: #ffffff !important;
        font-weight: 500;
        padding: 10px 20px;
        transition: all 0.2s ease;
    }
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
    }
    .btn-outline-dark, .btn-outline-dark:hover {
        border-color: #000000 !important;
        color: #000000 !important;
        font-weight: 500;
        padding: 10px 20px;
        transition: all 0.2s ease;
    }
    .btn-outline-dark:hover {
        background-color: #000000 !important;
        color: #ffffff !important;
    }
    .nav-pills .nav-link.active { 
        background-color: #000000 !important; 
        color: white !important;
        font-weight: 500;
    }
    .nav-pills .nav-link { 
        color: #555 !important; 
        font-weight: 500;
        padding: 10px 16px;
        transition: all 0.2s ease;
    }
    .nav-pills .nav-link:hover {
        background-color: #f5f5f5;
    }

    /* DASHBOARD & CARDS */
    .status-bar { height: 5px; width: 100%; border-radius: 4px 4px 0 0; }
    .bar-ready { background-color: #000; } 
    .bar-running { background-color: #198754; } 
    .bar-locked { background-color: #dc3545; }
    .d-none-view { display: none !important; }
    
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 16px;
        overflow: hidden;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .card-header {
        padding: 16px 20px;
    }
    
    .card h4 {
        margin-bottom: 12px;
        font-weight: 600;
    }
    
    .role-card {
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }
    
    .role-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    
    .list-group-item {
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
        padding: 16px 20px;
    }
    
    .list-group-item:hover {
        border-left-color: #000;
        background-color: #f8f9fa;
    }
    
    /* Accordion improvements */
    .accordion .card {
        margin-bottom: 12px;
    }
    
    /* Table improvements */
    .table {
        font-size: 14px;
    }
    
    .table thead th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.5px;
        color: #6c757d;
        border-bottom: 2px solid #dee2e6;
    }
    
    .table tbody tr {
        transition: background-color 0.15s ease;
    }
    
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    #sigCanvas { 
        border: 2px solid #dee2e6; 
        border-radius: 8px;
        width: 100%; 
        height: 200px; 
        touch-action: none; 
        background-color: white; 
    }
    
    .live-timer { font-variant-numeric: tabular-nums; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-card { animation: slideIn 0.3s ease-out forwards; }
  </style>
</head>
<body>

  <!-- LOADER -->
  <div id="loader" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex flex-column justify-content-center align-items-center" style="z-index:9999;">
    <h2 class="brand-font mb-3">STUDIO DELTA</h2>
    <div class="spinner-border text-dark"></div>
  </div>

  <!-- NAVIGATION -->
  <button class="menu-toggle" onclick="toggleSidebar()"><i class="bi bi-list fs-4"></i></button>

  <div class="sidebar" id="sidebar">
    <div class="px-4 mb-4 mt-4">
      <h4 class="brand-font mb-0">MENU</h4>
    </div>
    <nav>
      <a id="link-roles" class="sidebar-link active" onclick="navTo('view-roles')">
        <i class="bi bi-house-door me-2"></i>Home / Roles
      </a>
      <div id="adminLinks" class="d-none-view">
        <a id="link-prod" class="sidebar-link" onclick="loadProductionOverview()">
          <i class="bi bi-kanban me-2"></i>Production Overview
        </a>
        <a id="link-work" class="sidebar-link" onclick="loadWorkerStats()">
          <i class="bi bi-people me-2"></i>Worker Information
        </a>
      </div>
    </nav>
    <div class="mt-auto px-4 pt-5 pb-4">
      <button class="btn btn-outline-danger w-100 py-2" onclick="logout()">
        <i class="bi bi-box-arrow-right me-2"></i>Log Out
      </button>
    </div>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- MAIN CONTENT -->
  <div class="container-fluid" style="padding-top: 100px; padding-bottom: 40px;">
    
    <!-- VIEW: ROLE SELECTION -->
    <div id="view-roles" class="view-section container">
      <div class="text-center mb-5 mt-3">
        <h1 class="display-4 fw-bold mb-2">Studio Delta</h1>
        <p class="text-muted small text-uppercase letter-spacing-2">Production Management System</p>
      </div>
      <div class="row g-4" id="roleGrid"></div>
    </div>

    <!-- VIEW: USER SELECTION -->
    <div id="view-users" class="view-section container d-none-view">
      <button class="btn btn-outline-dark mb-4" onclick="navTo('view-roles')">
        <i class="bi bi-arrow-left me-2"></i>BACK
      </button>
      <h2 class="mb-4"><span id="selectedRoleTitle"></span> Team</h2>
      <div class="list-group list-group-flush bg-white rounded shadow-sm" id="userList"></div>
    </div>

    <!-- VIEW: WORKER DASHBOARD -->
    <div id="view-dashboard" class="view-section container d-none-view">
      <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
        <div>
          <h4 class="m-0 mb-1" id="dashUser">User</h4>
          <small class="text-muted text-uppercase" id="dashRole">Role</small>
        </div>
      </div>
      
      <input type="text" id="dashSearch" class="form-control mb-4" placeholder="Search Order #" onkeyup="filterDashboard()" aria-label="Search orders">

      <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded shadow-sm" id="dashTabs">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pane-available">Available</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-progress">In Progress</button>
        </li>
      </ul>
      <div class="text-end mb-3">
        <button class="btn btn-sm btn-link text-muted text-decoration-none" onclick="loadDashboard()">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
      </div>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="pane-available">
          <div id="container-available"></div>
        </div>
        <div class="tab-pane fade" id="pane-progress">
          <div id="container-progress"></div>
        </div>
      </div>
    </div>

    <!-- VIEW: ADMIN OVERVIEW -->
    <div id="view-admin-prod" class="view-section container d-none-view">
      <h2 class="brand-font mb-4">Production Overview</h2>
      
      <input type="text" id="prodSearch" class="form-control mb-4" placeholder="Search Order #" onkeyup="filterProduction()" aria-label="Search orders">

      <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm" id="adminProdTabs">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-notstarted">Not Started</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-production">In Production</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-delivery">Out for Delivery</button>
        </li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-notstarted">
          <div id="list-notstarted"></div>
        </div>
        <div class="tab-pane fade" id="tab-production">
          <div id="list-production"></div>
        </div>
        <div class="tab-pane fade" id="tab-delivery">
          <div id="list-delivery"></div>
        </div>
      </div>
    </div>

    <!-- VIEW: ADMIN WORKER STATS -->
    <div id="view-admin-workers" class="view-section container d-none-view">
      <h2 class="brand-font mb-4">Worker Information</h2>
      <div class="row g-4">
        <div class="col-md-4 mb-3">
          <div class="list-group" id="workerSelect_List"></div>
        </div>
        <div class="col-md-8">
          <div id="workerDetailContent" class="bg-white p-4 rounded shadow-sm">
            <p class="text-muted text-center">Select a worker to view details.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modal fade" id="passModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4 rounded-3 border-0 shadow">
        <h3 class="mb-3 brand-font">Access Code</h3>
        <p class="text-muted mb-3" id="passPromptName">Enter code</p>
        <input type="password" id="inputPass" class="form-control text-center mb-4 py-2">
        <button class="btn btn-primary w-100 py-3" onclick="submitPass()">ENTER</button>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="startModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4 rounded-3 border-0 shadow">
        <h3 class="brand-font mb-3">Start Order</h3>
        <h1 class="fw-bold mb-4" id="startModalOrder" style="font-size: 2.5rem;">...</h1>
        <button class="btn btn-primary btn-lg w-100 py-3 mt-2" onclick="confirmStart()">START TIMER</button>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="qcModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content rounded-3 border-0 shadow">
        <div class="modal-header border-bottom">
          <h5 class="modal-title brand-font">Quality Control Checklist</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4">
          <div class="mb-4 pb-3 border-bottom">
            <strong>Order:</strong> <span id="qcOrderNum" class="fw-bold"></span>
          </div>
          <div id="qcChecklistContainer"></div>
          <div class="mt-4 pt-3 border-top">
            <label class="fw-bold mb-2">Signature</label>
            <div class="border rounded">
              <canvas id="sigCanvas"></canvas>
            </div>
            <button class="btn btn-sm btn-outline-secondary mt-3" onclick="clearSignature()">
              <i class="bi bi-eraser"></i> Clear Signature
            </button>
          </div>
        </div>
        <div class="modal-footer border-top">
          <button class="btn btn-primary px-5 py-2" onclick="submitQC()">CONFIRM</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-3 border-0 shadow">
        <div class="modal-body text-center p-5">
          <h5 class="mb-4" id="alertMsg"></h5>
          <button class="btn btn-primary px-5 py-2" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-3 border-0 shadow">
        <div class="modal-body text-center p-5">
          <h5 class="mb-4" id="confirmMsg"></h5>
          <div class="d-flex justify-content-center gap-3">
            <button class="btn btn-primary px-5 py-2" id="confirmBtnYes">YES</button>
            <button class="btn btn-outline-dark px-5 py-2" data-bs-dismiss="modal">NO</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JAVASCRIPT -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- APP DATA ---
    let appData = { users: [], workerStats: {} };
    let session = { role: null, name: null, pendingRow: null, activeOrder: null, logId: null, isAdmin: false };
    let refreshInterval = null;
    let liveTimerInterval = null;
    let hasSigned = false;
    let confirmCallback = null;
    let isSubmitting = false; 

    // --- QC QUESTIONS CONFIG ---
    // Ensure keys match roles exactly
    const QC_DATA = {
      'Cutting': ["Does the overall dimensions of the cutting list match the Job Card?", "Are all the items on the cutting list cut?", "Are items cut exactly to size according to the cutting list?", "Have all the angles been cut where indicated?"],
      'Tagging': ["Have you read the description on the Job Card?", "Is there a drawing?", "Does the drawing match the description?", "If the drawing did not match, did you notify your supervisor?", "Was mistakes corrected?", "Does the measurements of the cut lengths match the cutting list and drawing?", "Is the frame square after tagging it?", "Are the dimensions of the frame the same as on the Job Card?", "Does the standard glass dimensions fit?", "If the unit is custom, did you measure the custom glass sizes?", "Did you indicate on the job card the custom glass dimensions?"],
      'Welding': ["Have you read the description on the Job Card?", "Is there a drawing?", "Does the drawing match the description?", "If the drawing did not match, did you notify your supervisor?", "Were mistakes corrected?", "Does the measurements of the cut lengths match the cutting list and drawing?", "Is the frame square after tagging it?", "Are the dimensions of the frame the same as on the Job Card?", "Does the standard glass dimensions fit?", "Have all the tag spots been welded?", "Have all plates been bent and welded in place?", "Are the plates flush, free from dents and scratches?", "Will the standard glass dimensions fit?", "If there are custom glass dimensions, will it fit?", "Is the frame still square?", "Is your name on the Job Card?"],
      'Grinding': ["Have all welds been ground flush?", "Are there any deep scratches?", "Is the surface smooth ready for coating?"],
      'Quality Control': ["Did you read the description on the job card?", "Is there a drawing?", "Does the item match the drawing?", "Does the colour of the item match the description?", "Do you have the top plate for the unit?", "Are there dents on the top plate or scratch marks?", "Is the paint free of defects and scratches?", "Did you report issues with the paint to your supervisor?", "Is the frame square?", "Did you check if the glass fits before putting it in?", "Did you clean the glass before putting it in?"],
      'Assembly': ["Did you cut and paint the backboard before fitting the glass?", "Did you fit the glass and make sure the glass clips align?", "Did you fit the handles, magnets and End Caps?", "Are the magnets and handles aligned and free of scratches?", "Did you fit the back board and make sure the screws are hidden?", "Did you wipe down the unit and remove excess silicon?", "Did you place rubber bumpers on the glass shelves and magnets?", "Did you level the unit for QC?", "Did you notify the cleaner that the unit is ready to be cleaned?"]
    };

    let passModal, startModal, qcModal, alertModal, confirmModal, canvas, ctx, isDrawing = false;

    document.addEventListener('DOMContentLoaded', () => {
      // Init Bootstrap Modals
      passModal = new bootstrap.Modal('#passModal');
      startModal = new bootstrap.Modal('#startModal');
      qcModal = new bootstrap.Modal('#qcModal');
      alertModal = new bootstrap.Modal('#alertModal');
      confirmModal = new bootstrap.Modal('#confirmModal');
      
      initSigPad();
      initApp();
      startLiveTimers();
      
      document.getElementById('confirmBtnYes').onclick = () => { confirmModal.hide(); if(confirmCallback) confirmCallback(); };
    });

    // --- UI HELPERS ---
    function showAlert(msg) { document.getElementById('alertMsg').innerText = msg; alertModal.show(); }
    function showConfirm(msg, cb) { document.getElementById('confirmMsg').innerText = msg; confirmCallback = cb; confirmModal.show(); }
    function toggleSidebar() { 
        document.getElementById('sidebar').classList.toggle('active'); 
        document.getElementById('sidebarOverlay').classList.toggle('active');
        
        // This line makes the button slide with the menu
        document.querySelector('.menu-toggle').classList.toggle('active'); 
    }
    
    function navTo(viewId) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none-view'));
      document.getElementById(viewId).classList.remove('d-none-view');
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
      
      let linkId = '';
      if(viewId.includes('roles') || viewId.includes('users') || viewId.includes('dashboard')) linkId = 'link-roles';
      if(viewId.includes('prod')) linkId = 'link-prod';
      if(viewId.includes('workers')) linkId = 'link-work';
      
      const linkEl = document.getElementById(linkId); if(linkEl) linkEl.classList.add('active');
      
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('sidebarOverlay').classList.remove('active');
      
      if(viewId !== 'view-dashboard') stopAutoRefresh();
    }

    // --- INITIALIZATION ---
    function initApp() {
      google.script.run.withSuccessHandler(data => {
        appData.users = data; 
        renderRoles(); 
        document.getElementById('loader').classList.add('d-none');
      }).getUsersAndRoles();
    }

    function renderRoles() {
      const grid = document.getElementById('roleGrid'); 
      grid.innerHTML = '';
      const roles = [...new Set(appData.users.map(u => u.role))].sort();
      roles.forEach(r => {
        grid.innerHTML += `
          <div class="col-md-4 col-sm-6">
            <div class="card p-4 text-center h-100 role-card" onclick="selectRole('${r}')">
              <h4 class="mb-0">${r}</h4>
            </div>
          </div>`;
      });
    }

    function selectRole(r) { 
      session.role = r; 
      if(r.toLowerCase() === 'admin') promptPass('Admin'); 
      else renderUsers(r); 
    }

    function renderUsers(r) {
      const list = document.getElementById('userList'); 
      document.getElementById('selectedRoleTitle').innerText = r; 
      list.innerHTML = '';
      appData.users.filter(u => u.role === r).forEach(u => {
        list.innerHTML += `
          <button class="list-group-item list-group-item-action py-3 fw-bold" onclick="promptPass('${u.name}')">
            <i class="bi bi-person-circle me-2"></i>${u.name}
          </button>`;
      });
      navTo('view-users');
    }

    function promptPass(n) { 
      session.name = n; 
      document.getElementById('passPromptName').innerText = "Code for " + n; 
      document.getElementById('inputPass').value=''; 
      passModal.show(); 
    }

    function submitPass() {
      const p = document.getElementById('inputPass').value;
      google.script.run.withSuccessHandler(res => {
        if(res.success) { 
          session.isAdmin = res.isAdmin; 
          passModal.hide(); 
          if(session.role === 'Admin') {
            document.getElementById('adminLinks').classList.remove('d-none-view');
            loadProductionOverview();
          } else {
            document.getElementById('adminLinks').classList.add('d-none-view');
            enterDashboard();
          }
        } else {
          showAlert(res.error);
        }
      }).verifyLogin(session.role, session.name, p);
    }
    
    function logout() { 
      session = {}; 
      document.getElementById('adminLinks').classList.add('d-none-view'); 
      navTo('view-roles'); 
    }

    // --- FILTERING ---
    function filterDashboard() {
      const q = document.getElementById('dashSearch').value.toLowerCase();
      document.querySelectorAll('#view-dashboard .card').forEach(c => {
        const txt = c.querySelector('h4').innerText.toLowerCase();
        c.style.display = txt.includes(q) ? '' : 'none';
      });
    }
    function filterProduction() {
      const q = document.getElementById('prodSearch').value.toLowerCase();
      document.querySelectorAll('#view-admin-prod .card').forEach(c => {
        const txt = c.querySelector('button div strong').innerText.toLowerCase();
        c.style.display = txt.includes(q) ? '' : 'none';
      });
    }
    function filterWorkerLogs() {
      const q = document.getElementById('workerLogSearch').value.toLowerCase();
      document.querySelectorAll('#workerLogTable tbody tr').forEach(row => {
        const txt = row.cells[1].innerText.toLowerCase();
        row.style.display = txt.includes(q) ? '' : 'none';
      });
    }

    // --- DASHBOARD LOGIC ---
    function enterDashboard() {
      navTo('view-dashboard');
      document.getElementById('dashUser').innerText = session.name;
      document.getElementById('dashRole').innerText = session.role;
      const tabEl = document.querySelector('#dashTabs button[data-bs-target="#pane-available"]');
      if(tabEl) new bootstrap.Tab(tabEl).show();
      loadDashboard(false);
      startAutoRefresh();
    }
    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(() => { if (!document.querySelector('.modal.show')) loadDashboard(true); }, 30000); 
    }
    function stopAutoRefresh() { if (refreshInterval) clearInterval(refreshInterval); }

    function loadDashboard(silent = false) {
      if(!silent) document.getElementById('container-available').innerHTML = '<div class="spinner-border"></div>';
      
      google.script.run.withSuccessHandler(orders => {
        const av = document.getElementById('container-available'); 
        const pr = document.getElementById('container-progress');
        av.innerHTML = ''; pr.innerHTML = '';
        
        orders.forEach(o => {
          const isMine = o.assigned === session.name;
          const isLocked = o.assigned && !isMine;
          const cardId = `card-${o.rowIndex}`;
          let btn = '';
          
          if (session.isAdmin) {
             btn = `<button class="btn btn-secondary w-100" disabled><i class="bi bi-eye-fill"></i> ADMIN VIEW ONLY</button>`;
          } else {
             if(isMine) {
               btn = `<button class="btn btn-success w-100" onclick="preFinish(${o.rowIndex}, '${o.order}')">FINISH & QC</button>`;
             } else if(isLocked) {
               btn = `<button class="btn btn-secondary w-100" disabled>LOCKED BY ${o.assigned}</button>`;
             } else {
               btn = `<button class="btn btn-primary w-100" onclick="preStart(${o.rowIndex}, '${o.order}')">START</button>`;
             }
          }

          const html = `
            <div class="card mb-3 animate-card" id="${cardId}">
              <div class="status-bar ${isMine?'bar-running':(isLocked?'bar-locked':'bar-ready')}"></div>
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h4 class="mb-0">${o.order}</h4>
                  <span class="badge bg-dark">${o.status}</span>
                </div>
                ${btn}
              </div>
            </div>`;
          
          if(isMine) pr.innerHTML += html; else av.innerHTML += html;
        });
        filterDashboard(); 
      }).getOrdersForRole(session.role);
    }
    
    // --- ACTIONS ---
    function preStart(row, ord) { 
      session.pendingRow = row; 
      session.activeOrder = ord; 
      document.getElementById('startModalOrder').innerText = ord; 
      startModal.show(); 
    }
    
    function confirmStart() {
      if (isSubmitting) return; 
      isSubmitting = true;
      startModal.hide();
      
      const card = document.getElementById(`card-${session.pendingRow}`);
      if(card) {
        card.querySelector('.status-bar').className = 'status-bar bar-running';
        card.querySelector('button').parentNode.innerHTML = `<button class="btn btn-success w-100" disabled>SYNCING...</button>`;
        document.getElementById('container-progress').appendChild(card);
        new bootstrap.Tab(document.querySelector('#dashTabs button[data-bs-target="#pane-progress"]')).show();
      }
      
      // Pass OrderNumber for verification
      google.script.run.withSuccessHandler(res => { 
        isSubmitting = false;
        if(res.success) {
           session.logId = res.logId; 
           loadDashboard(true);
        } else {
           showAlert(res.message || "Error starting order");
           loadDashboard();
        }
      }).withFailureHandler(err => { 
        isSubmitting=false; 
        showAlert("Error: "+err); 
        loadDashboard(); 
      }).startOrder(session.pendingRow, session.activeOrder, session.name, session.role);
    }
    
    function preFinish(row, ord) { 
      session.pendingRow = row; 
      session.activeOrder = ord; 
      
      // Get QC Questions
      const qs = QC_DATA[session.role];
      
      // If role has no specific QC, we can skip or show confirm
      if (!qs || qs.length === 0) {
        showConfirm("Finish Order " + ord + "?", () => submitQC(true));
        return;
      }

      let h = ''; 
      qs.forEach((q,i) => {
        h += `
          <div class="mb-4 pb-3 border-bottom">
            <div class="fw-bold mb-3" style="color: #333; font-size: 15px;">${q}</div>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="q${i}" id="q${i}y" value="Y" autocomplete="off">
              <label class="btn btn-outline-success py-2" for="q${i}y" style="flex: 1;">YES</label>
              <input type="radio" class="btn-check" name="q${i}" id="q${i}n" value="N" autocomplete="off">
              <label class="btn btn-outline-danger py-2" for="q${i}n" style="flex: 1;">NO</label>
            </div>
          </div>`;
      });
      document.getElementById('qcChecklistContainer').innerHTML = h;
      document.getElementById('qcOrderNum').innerText = ord; 
      clearSignature(); 
      qcModal.show();
    }

    function submitQC(skip=false) {
      if(isSubmitting) return;
      let d = [], sig = '';
      
      if(!skip) {
        const qs = QC_DATA[session.role];
        let allAnswered = true;
        
        if (qs) {
            qs.forEach((q,i) => { 
                const el = document.querySelector(`input[name="q${i}"]:checked`); 
                if(!el) allAnswered=false; 
                else d.push({q:q, a:el.value}); 
            });
            if(!allAnswered) { showAlert("Please answer all questions."); return; }
            if(!hasSigned) { showAlert("Please sign before confirming."); return; } 
            sig = canvas.toDataURL();
        }
      }
      
      isSubmitting = true;
      qcModal.hide();
      
      // Optimistic UI update
      const card = document.getElementById(`card-${session.pendingRow}`);
      if(card) { card.style.opacity='0.5'; setTimeout(()=>card.remove(), 500); }
      
      google.script.run.withSuccessHandler(() => { 
        isSubmitting=false; 
        loadDashboard(true); 
      }).finishOrder(session.pendingRow, session.activeOrder, session.logId, d, sig);
    }

    // --- TIME CALCULATION (Client Side Display Only) ---
    function calculateWorkMinutes(startTs, endTs, taskName) {
      if (!startTs) return 0;
      let start = new Date(parseInt(startTs));
      let end = endTs ? new Date(parseInt(endTs)) : new Date();
      let totalMinutes = 0;
      let current = new Date(start.getTime());
      
      if (taskName && taskName.toLowerCase().includes('powder')) {
        return (end - start) / 1000 / 60;
      }

      let safety = 0;
      while (current < end && safety < 500) { 
        safety++;
        let day = current.getDay();
        if (day === 0 || day === 6) {
          current.setDate(current.getDate() + 1);
          current.setHours(7, 30, 0, 0);
          continue;
        }
        let shiftStart = new Date(current); shiftStart.setHours(7, 30, 0, 0);
        let shiftEnd = new Date(current); shiftEnd.setHours(15, 45, 0, 0);
        
        let windowStart = (current > shiftStart) ? current : shiftStart;
        let windowEnd = (end < shiftEnd) ? end : shiftEnd;
        
        if (windowStart < windowEnd) {
          totalMinutes += (windowEnd - windowStart) / 1000 / 60;
        }
        if (end < shiftEnd) break; 
        else { 
            current.setDate(current.getDate() + 1); 
            current.setHours(7, 30, 0, 0); 
        }
      }
      return Math.floor(totalMinutes);
    }

    function formatDuration(totalMins) {
      let h = Math.floor(totalMins / 60);
      let m = Math.floor(totalMins % 60);
      return (h < 10 ? "0"+h : h) + ":" + (m < 10 ? "0"+m : m);
    }

    function startLiveTimers() {
      if(liveTimerInterval) clearInterval(liveTimerInterval);
      liveTimerInterval = setInterval(() => {
        document.querySelectorAll('.live-timer').forEach(el => {
          const start = el.getAttribute('data-start');
          const task = el.getAttribute('data-task');
          if(start) {
            const mins = calculateWorkMinutes(start, null, task);
            el.innerText = formatDuration(mins);
          }
        });
      }, 1000); 
    }

    // --- ADMIN VIEWS ---
    function loadProductionOverview() {
      navTo('view-admin-prod');
      const tabEl = document.querySelector('#adminProdTabs button[data-bs-target="#tab-notstarted"]');
      if(tabEl) new bootstrap.Tab(tabEl).show();

      document.getElementById('list-notstarted').innerHTML = '<div class="spinner-border"></div>';
      document.getElementById('list-production').innerHTML = '<div class="spinner-border"></div>';
      document.getElementById('list-delivery').innerHTML = '<div class="spinner-border"></div>';

      google.script.run.withSuccessHandler(data => {
        const rawLogs = data.logs;
        const allOrders = data.orders;
        const orderLogs = {};
        
        rawLogs.forEach(r => {
          if (!orderLogs[r.order]) orderLogs[r.order] = [];
          r.durationMins = calculateWorkMinutes(r.start, r.end, r.task);
          orderLogs[r.order].push(r);
        });

        let htmlNotStarted = '<div class="accordion">';
        let htmlProd = '<div class="accordion">';
        let htmlDeliv = '<div class="accordion">';

        allOrders.forEach((o, i) => {
          const status = String(o.status).toLowerCase();
          const tasks = orderLogs[o.order] || [];
          const totalDuration = tasks.reduce((sum, t) => sum + t.durationMins, 0);
          const totalTimeStr = formatDuration(totalDuration);
          const isRunning = tasks.some(t => !t.end);
          
          let item = `
            <div class="card mb-3 shadow-sm">
              <div class="card-header bg-white border-0">
                <button class="btn btn-link text-decoration-none text-dark w-100 text-start d-flex justify-content-between align-items-center p-0" 
                        type="button" data-bs-toggle="collapse" data-bs-target="#ord-${i}">
                  <div>
                    <strong class="fs-5">${o.order}</strong> 
                    <span class="badge bg-light text-dark border ms-2">${o.status}</span>
                  </div>
                  <div>
                    ${isRunning ? '<span class="badge bg-success me-2">Active</span>' : ''}
                    <span class="badge bg-dark">${totalTimeStr}</span>
                  </div>
                </button>
              </div>
              <div id="ord-${i}" class="collapse">
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0 table-hover">
                      <thead class="table-light">
                        <tr>
                          <th>Worker</th>
                          <th>Task</th>
                          <th>Start</th>
                          <th>End</th>
                          <th>Duration</th>
                          <th>QC</th>
                        </tr>
                      </thead>
                      <tbody>`;
          
          if(tasks.length === 0) {
            item += `<tr><td colspan="6" class="text-center text-muted py-3">No activity recorded yet.</td></tr>`;
          } else {
            tasks.forEach(t => {
              const startDisplay = t.start ? new Date(t.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '-';
              const endDisplay = t.end ? new Date(t.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '-';
              let durDisplay = formatDuration(t.durationMins);
              if(!t.end) durDisplay = `<span class="badge bg-success live-timer" data-start="${t.start}" data-task="${t.task}">${durDisplay}</span>`;
              const qcIcon = t.qc && t.qc !== 'Skipped' ? '<i class="bi bi-check-circle-fill text-success"></i>' : '-';
              item += `<tr><td>${t.worker}</td><td>${t.task}</td><td>${startDisplay}</td><td>${endDisplay}</td><td>${durDisplay}</td><td>${qcIcon}</td></tr>`;
            });
          }
          item += `</tbody></table></div></div></div></div>`;

          if (status.startsWith('not yet started')) htmlNotStarted += item;
          else if (status.startsWith('out for') || status.startsWith('delivered')) htmlDeliv += item;
          else htmlProd += item;
        });

        htmlNotStarted += '</div>'; htmlProd += '</div>'; htmlDeliv += '</div>';
        document.getElementById('list-notstarted').innerHTML = htmlNotStarted || '<p class="text-muted">Empty</p>';
        document.getElementById('list-production').innerHTML = htmlProd || '<p class="text-muted">Empty</p>';
        document.getElementById('list-delivery').innerHTML = htmlDeliv || '<p class="text-muted">Empty</p>';
        filterProduction(); 
      }).getAdminDashboardData();
    }

    function loadWorkerStats() {
      navTo('view-admin-workers');
      document.getElementById('workerSelect_List').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
      
      google.script.run.withSuccessHandler(data => {
        const rawLogs = data.logs;
        appData.workerStats = {};
        
        rawLogs.forEach(r => {
          if(!r.worker) return;
          if(!appData.workerStats[r.worker]) appData.workerStats[r.worker] = { totalMins: 0, logs: [] };
          const dur = calculateWorkMinutes(r.start, r.end, r.task);
          appData.workerStats[r.worker].totalMins += dur;
          r.durationMins = dur;
          appData.workerStats[r.worker].logs.push(r);
        });
        
        let h = '';
        Object.keys(appData.workerStats).sort().forEach(name => {
          const w = appData.workerStats[name];
          h += `<button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="showWorkerDetail('${name}')"><span><i class="bi bi-person-circle me-2"></i>${name}</span><span class="badge bg-dark rounded-pill">${formatDuration(w.totalMins)}</span></button>`;
        });
        document.getElementById('workerSelect_List').innerHTML = h;
      }).getAdminDashboardData();
    }

    function showWorkerDetail(name) {
      const w = appData.workerStats[name];
      let h = `<div class="mb-4 pb-3 border-bottom"><h4 class="brand-font mb-2">${name}</h4><div class="card bg-light"><div class="card-body text-center"><h6 class="text-muted text-uppercase small mb-1">Total Hours</h6><h2 class="mb-0 text-primary">${formatDuration(w.totalMins)}</h2></div></div></div>`;
      
      h += `<input type="text" id="workerLogSearch" class="form-control mb-3" placeholder="Search Order # in logs..." onkeyup="filterWorkerLogs()">`;
      
      h += '<div class="mb-3"><div class="table-responsive"><table class="table table-striped table-sm" id="workerLogTable"><thead class="table-light"><tr><th>Date</th><th>Order</th><th>Task</th><th>Start</th><th>End</th><th class="text-end">Duration</th></tr></thead><tbody>';
      
      w.logs.sort((a,b) => b.start - a.start).forEach(l => {
        const d = l.start ? new Date(l.start).toLocaleDateString() : '-';
        const s = l.start ? new Date(l.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '-';
        const e = l.end ? new Date(l.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '<span class="badge bg-success">Running</span>';
        
        let durDisplay = formatDuration(l.durationMins);
        if(!l.end) durDisplay = `<span class="badge bg-success live-timer" data-start="${l.start}" data-task="${l.task}">${durDisplay}</span>`;
        
        h += `<tr><td>${d}</td><td><strong>${l.order}</strong></td><td>${l.task}</td><td>${s}</td><td>${e}</td><td class="text-end">${durDisplay}</td></tr>`;
      });
      h += '</tbody></table></div></div>';
      document.getElementById('workerDetailContent').innerHTML = h;
    }

    // --- SIGNATURE PAD ---
    function initSigPad() {
      canvas = document.getElementById('sigCanvas'); 
      ctx = canvas.getContext('2d');
      ctx.lineWidth=2; 
      
      // Resize for retina/mobile
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      
      canvas.addEventListener('mousedown', sD); 
      canvas.addEventListener('mousemove', dD); 
      canvas.addEventListener('mouseup', () => isDrawing=false);
      
      canvas.addEventListener('touchstart', e=>{e.preventDefault();sD(e.touches[0])}, {passive: false}); 
      canvas.addEventListener('touchmove', e=>{e.preventDefault();dD(e.touches[0])}, {passive: false});
    }
    
    function sD(e) { 
        isDrawing=true; hasSigned=true; 
        const r=canvas.getBoundingClientRect(); 
        ctx.beginPath(); 
        ctx.moveTo(e.clientX-r.left, e.clientY-r.top); 
    }
    function dD(e) { 
        if(!isDrawing)return; 
        const r=canvas.getBoundingClientRect(); 
        ctx.lineTo(e.clientX-r.left, e.clientY-r.top); 
        ctx.stroke(); 
    }
    function clearSignature() { 
        hasSigned=false; 
        ctx.clearRect(0,0,canvas.width,canvas.height); 
    }
  </script>
</body>
</html>
