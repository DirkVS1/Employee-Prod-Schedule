<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Studio Delta</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    :root { 
      --sd-bg: #EBEAE6; 
      --sd-text: #1a1a1a; 
      --sd-accent: #000000; 
      --sd-white: #ffffff;
      --sd-primary: #2c3e50;
      --sd-success: #27ae60;
      --sd-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    body { 
      background-color: var(--sd-bg); 
      color: var(--sd-text); 
      font-family: 'Lato', sans-serif; 
      overflow-x: hidden; 
      line-height: 1.6;
    }
    
    h1, h2, h3, h4, h5, .brand-font { 
      font-family: 'Playfair Display', serif; 
      color: var(--sd-accent); 
      font-weight: 600;
    }
    
    /* SIDEBAR */
    .sidebar { 
      position: fixed; 
      top: 0; 
      left: 0; 
      height: 100vh; 
      width: 280px; 
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      z-index: 1000; 
      transform: translateX(-100%); 
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      box-shadow: 4px 0 16px rgba(0,0,0,0.15); 
      padding-top: 70px; 
    }
    
    .sidebar.active { 
      transform: translateX(0); 
    }
    
    .sidebar-link { 
      display: block; 
      padding: 16px 28px; 
      color: rgba(255,255,255,0.9); 
      text-decoration: none; 
      font-weight: 500; 
      border-left: 4px solid transparent; 
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }
    
    .sidebar-link:hover {
      background: rgba(255,255,255,0.1);
      color: white;
      border-left-color: white;
    }
    
    .sidebar-link.active { 
      background: rgba(255,255,255,0.15); 
      border-left-color: white;
      color: white;
    }
    
    .sidebar-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.5); 
      z-index: 999; 
      display: none; 
      backdrop-filter: blur(2px);
    }
    
    .sidebar-overlay.active { 
      display: block; 
    }
    
    /* NAV TOGGLE */
    .menu-toggle { 
      position: fixed; 
      top: 20px; 
      left: 20px; 
      z-index: 1100; 
      background: white; 
      border: none; 
      padding: 12px 16px; 
      border-radius: 8px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
      transition: all 0.2s ease;
    }
    
    .menu-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }

    /* CARDS & UI */
    .card { 
      border: none; 
      border-radius: 12px; 
      background-color: var(--sd-white); 
      box-shadow: var(--sd-shadow); 
      transition: all 0.3s ease; 
      overflow: hidden;
    }
    
    .card:hover {
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    
    .role-card {
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .role-card:hover {
      border-color: var(--sd-accent);
    }
    
    .btn-primary { 
      background-color: var(--sd-accent); 
      border-color: var(--sd-accent); 
      color: var(--sd-white); 
      border-radius: 6px; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      font-size: 0.85rem; 
      font-weight: 600;
      padding: 12px 24px; 
      transition: all 0.2s ease;
    }
    
    .btn-primary:hover { 
      background-color: #333; 
      border-color: #333; 
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .status-bar { 
      height: 5px; 
      width: 100%; 
    }
    
    .bar-ready { 
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); 
    } 
    
    .bar-running { 
      background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%); 
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .d-none-view { 
      display: none !important; 
    }
    
    #sigCanvas { 
      border: 2px solid #e0e0e0; 
      width: 100%; 
      height: 200px; 
      border-radius: 8px;
      background: #fafafa;
    }
    
    /* Tables */
    .table {
      margin-bottom: 0;
    }
    
    .table-responsive {
      border-radius: 8px;
      overflow: hidden;
    }
    
    .table thead th {
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #dee2e6;
    }
    
    .accordion-button:not(.collapsed) {
      background-color: #f8f9fa;
      color: var(--sd-accent);
    }
    
    .accordion-button:focus {
      box-shadow: none;
      border-color: rgba(0,0,0,.125);
    }
    
    /* List groups */
    .list-group-item-action:hover {
      background-color: #f8f9fa;
      cursor: pointer;
    }
    
    /* Badges */
    .badge {
      font-weight: 500;
      padding: 0.4em 0.8em;
      border-radius: 6px;
    }
    
    /* Animations */
    @keyframes slideIn { 
      from { 
        opacity: 0; 
        transform: translateY(20px); 
      } 
      to { 
        opacity: 1; 
        transform: translateY(0); 
      } 
    }
    
    .animate-card { 
      animation: slideIn 0.4s ease-out forwards; 
    }
    
    /* Modals */
    .modal-content {
      border-radius: 12px;
      border: none;
    }
    
    .modal-header {
      border-bottom: 2px solid #f0f0f0;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 250px;
      }
      
      .container-fluid {
        padding-left: 10px;
        padding-right: 10px;
      }
    }
  </style>
</head>
<body>

  <div id="loader" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex flex-column justify-content-center align-items-center" style="z-index:9999;">
    <h2 class="brand-font mb-3">STUDIO DELTA</h2>
    <div class="spinner-border text-dark"></div>
  </div>

  <button class="menu-toggle" onclick="toggleSidebar()"><i class="bi bi-list fs-4"></i></button>

  <div class="sidebar" id="sidebar">
    <div class="px-4 mb-4">
      <h4 class="brand-font text-white">STUDIO DELTA</h4>
      <p class="text-white-50 small mb-0">Production System</p>
    </div>
    <a href="#" class="sidebar-link active" onclick="navTo('view-roles'); event.preventDefault(); setActiveLink(event.currentTarget)">
      <i class="bi bi-house-door me-2"></i> Home / Roles
    </a>
    <div id="adminLinks" class="d-none-view">
      <a href="#" class="sidebar-link" onclick="loadProductionOverview(); event.preventDefault(); setActiveLink(event.currentTarget)">
        <i class="bi bi-bar-chart-line me-2"></i> Production Overview
      </a>
      <a href="#" class="sidebar-link" onclick="loadWorkerStats(); event.preventDefault(); setActiveLink(event.currentTarget)">
        <i class="bi bi-people me-2"></i> Worker Information
      </a>
    </div>
    <div class="mt-auto px-4 pt-5 pb-4">
      <button class="btn btn-outline-light w-100" onclick="logout()">
        <i class="bi bi-box-arrow-right me-2"></i> Log Out
      </button>
    </div>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <div class="container-fluid py-5" style="padding-top: 80px;">
    
    <div id="view-roles" class="view-section container">
      <div class="text-center mb-5">
        <h1 class="display-4 fw-bold">Studio Delta</h1>
        <p class="text-muted small text-uppercase">Production Management System</p>
      </div>
      <div class="row g-3" id="roleGrid"></div>
    </div>

    <div id="view-users" class="view-section container d-none-view">
      <button class="btn btn-outline-dark mb-4" onclick="navTo('view-roles')">&larr; BACK</button>
      <h2 class="mb-4"><span id="selectedRoleTitle"></span> Team</h2>
      <div class="list-group list-group-flush bg-white rounded shadow-sm" id="userList"></div>
    </div>

    <div id="view-dashboard" class="view-section container d-none-view">
      <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
        <div><h4 class="m-0" id="dashUser">User</h4><small class="text-muted text-uppercase" id="dashRole">Role</small></div>
      </div>
      <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded shadow-sm" id="dashTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pane-available">Available</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-progress">In Progress</button></li>
      </ul>
      <div class="text-end mb-2"><button class="btn btn-sm btn-link text-muted text-decoration-none" onclick="loadDashboard()"><i class="bi bi-arrow-clockwise"></i> Refresh</button></div>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="pane-available"><div id="container-available"></div></div>
        <div class="tab-pane fade" id="pane-progress"><div id="container-progress"></div></div>
      </div>
    </div>

    <div id="view-admin-prod" class="view-section container d-none-view">
      <div class="mb-4">
        <h2 class="brand-font">Production Overview</h2>
        <p class="text-muted">All orders in production with detailed task breakdown</p>
      </div>
      <div id="prodOverviewContent"></div>
    </div>

    <div id="view-admin-workers" class="view-section container d-none-view">
      <div class="mb-4">
        <h2 class="brand-font">Worker Information</h2>
        <p class="text-muted">View detailed worker statistics and time logs</p>
      </div>
      <div class="row">
        <div class="col-lg-3 col-md-4 mb-4">
          <div class="card sticky-top" style="top: 100px;">
            <div class="card-header bg-dark text-white">
              <h6 class="mb-0"><i class="bi bi-people-fill me-2"></i>Workers</h6>
            </div>
            <div class="list-group list-group-flush" id="workerSelect_List"></div>
          </div>
        </div>
        <div class="col-lg-9 col-md-8">
          <div id="workerDetailContent" class="card p-4">
            <div class="text-center text-muted py-5">
              <i class="bi bi-person-plus-fill" style="font-size: 3rem; opacity: 0.3;"></i>
              <p class="mt-3">Select a worker to view detailed statistics</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="modal fade" id="passModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-4"><h3 class="mb-3">Access Code</h3><p class="text-muted" id="passPromptName">Enter code</p><input type="password" id="inputPass" class="form-control text-center mb-3" inputmode="numeric"><div id="passError" class="text-danger small fw-bold mb-3"></div><button class="btn btn-primary w-100" onclick="submitPass()">ENTER</button></div></div></div>
  
  <div class="modal fade" id="startModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-4"><h3 class="brand-font mb-2">Start Order</h3><h1 class="fw-bold text-primary mb-3" id="startModalOrder">...</h1><button class="btn btn-primary btn-lg w-100 mt-3" onclick="confirmStart()">START TIMER</button></div></div></div>
  
  <div class="modal fade" id="qcModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title brand-font">Checklist</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><div class="mb-3"><strong>Order:</strong> <span id="qcOrderNum"></span></div><div id="qcChecklistContainer"></div><div class="mt-4"><label class="fw-bold">Signature</label><div class="border"><canvas id="sigCanvas"></canvas></div><button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearSignature()">Clear</button></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitQC()">CONFIRM</button></div></div></div></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let appData = { users: [], workerStats: {} };
    let session = { role: null, name: null, pendingRow: null, activeOrder: null, logId: null };
    let refreshInterval = null;

    // --- FULL QC DATA ---
    const QC_DATA = {
      'Cutting': [
        "Does the overall dimensions of the cutting list match the Job Card?",
        "Are all the items on the cutting list cut?",
        "Are items cut exactly to size according to the cutting list?",
        "Have all the angles been cut where indicated?"
      ],
      'Tagging': [
        "Have you read the description on the Job Card?",
        "Is there a drawing?",
        "Does the drawing match the description?",
        "If the drawing did not match, did you notify your supervisor?",
        "Was mistakes corrected?",
        "Does the measurements of the cut lengths match the cutting list and drawing?",
        "Is the frame square after tagging it?",
        "Are the dimensions of the frame the same as on the Job Card?",
        "Does the standard glass dimensions fit?",
        "If the unit is custom, did you measure the custom glass sizes?",
        "Did you indicate on the job card the custom glass dimensions?"
      ],
      'Welding': [
        "Have you read the description on the Job Card?",
        "Is there a drawing?",
        "Does the drawing match the description?",
        "If the drawing did not match, did you notify your supervisor?",
        "Were mistakes corrected?",
        "Does the measurements of the cut lengths match the cutting list and drawing?",
        "Is the frame square after tagging it?",
        "Are the dimensions of the frame the same as on the Job Card?",
        "Does the standard glass dimensions fit?",
        "Have all the tag spots been welded?",
        "Have all plates been bent and welded in place?",
        "Are the plates flush, free from dents and scratches?",
        "Will the standard glass dimensions fit?",
        "If there are custom glass dimensions, will it fit?",
        "Is the frame still square?",
        "Is your name on the Job Card?"
      ],
      'Quality Control': [
        "Did you read the description on the job card?",
        "Is there a drawing?",
        "Does the item match the drawing?",
        "Does the colour of the item match the description?",
        "Do you have the top plate for the unit?",
        "Are there dents on the top plate or scratch marks?",
        "Is the paint free of defects and scratches?",
        "Did you report issues with the paint to your supervisor?",
        "Is the frame square?",
        "Did you check if the glass fits before putting it in?",
        "Did you clean the glass before putting it in?"
      ],
      'Assembly': [
        "Did you cut and paint the backboard before fitting the glass?",
        "Did you fit the glass and make sure the glass clips align?",
        "Did you fit the handles, magnets and End Caps?",
        "Are the magnets and handles aligned and free of scratches?",
        "Did you fit the back board and make sure the screws are hidden?",
        "Did you wipe down the unit and remove excess silicon?",
        "Did you place rubber bumpers on the glass shelves and magnets?",
        "Did you level the unit for QC?",
        "Did you notify the cleaner that the unit is ready to be cleaned?"
      ]
    };

    let passModal, startModal, qcModal, canvas, ctx, isDrawing = false;

    document.addEventListener('DOMContentLoaded', () => {
      passModal = new bootstrap.Modal('#passModal');
      startModal = new bootstrap.Modal('#startModal');
      qcModal = new bootstrap.Modal('#qcModal');
      initSigPad();
      initApp();
    });

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
      document.getElementById('sidebarOverlay').classList.toggle('active');
    }
    
    function setActiveLink(link) {
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
    }

    function navTo(viewId) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none-view'));
      document.getElementById(viewId).classList.remove('d-none-view');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('sidebarOverlay').classList.remove('active');
      
      // Stop refresh if leaving dashboard
      if(viewId !== 'view-dashboard') stopAutoRefresh();
    }

    function initApp() {
      google.script.run.withSuccessHandler(data => {
        appData.users = data; renderRoles(); 
        document.getElementById('loader').classList.add('d-none');
      }).getUsersAndRoles();
    }

    function renderRoles() {
      const grid = document.getElementById('roleGrid'); grid.innerHTML = '';
      [...new Set(appData.users.map(u => u.role))].sort().forEach(r => {
        grid.innerHTML += `<div class="col-md-4"><div class="card p-4 text-center h-100 role-card" onclick="selectRole('${r}')"><h4>${r}</h4></div></div>`;
      });
    }

    function selectRole(r) { session.role = r; r.toLowerCase() === 'admin' ? promptPass('Admin') : renderUsers(r); }
    function renderUsers(r) {
      const list = document.getElementById('userList'); document.getElementById('selectedRoleTitle').innerText = r; list.innerHTML = '';
      appData.users.filter(u => u.role === r).forEach(u => list.innerHTML += `<button class="list-group-item list-group-item-action py-3 fw-bold" onclick="promptPass('${u.name}')">${u.name}</button>`);
      navTo('view-users');
    }
    function promptPass(n) { session.name = n; document.getElementById('passPromptName').innerText = "Code for " + n; document.getElementById('inputPass').value=''; passModal.show(); }

    function submitPass() {
      const p = document.getElementById('inputPass').value;
      google.script.run.withSuccessHandler(res => {
        if(res.success) { 
          passModal.hide(); 
          if(session.role === 'Admin') {
            document.getElementById('adminLinks').classList.remove('d-none-view');
            loadProductionOverview();
          } else {
            enterDashboard();
          }
        } else alert(res.error);
      }).verifyLogin(session.role, session.name, p);
    }
    
    function logout() { 
      session = {}; document.getElementById('adminLinks').classList.add('d-none-view'); navTo('view-roles'); 
    }

    // --- WORKER DASHBOARD ---
    function enterDashboard() {
      navTo('view-dashboard');
      document.getElementById('dashUser').innerText = session.name;
      document.getElementById('dashRole').innerText = session.role;
      // Default to Available Tab
      const tabEl = document.querySelector('#dashTabs button[data-bs-target="#pane-available"]');
      if(tabEl) new bootstrap.Tab(tabEl).show();
      loadDashboard(false);
      startAutoRefresh();
    }

    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(() => {
        if (!document.querySelector('.modal.show')) loadDashboard(true);
      }, 30000); 
    }
    function stopAutoRefresh() { if (refreshInterval) clearInterval(refreshInterval); }

    function loadDashboard(silent = false) {
      if(!silent) document.getElementById('container-available').innerHTML = '<div class="spinner-border"></div>';
      google.script.run.withSuccessHandler(orders => {
        const av = document.getElementById('container-available'); const pr = document.getElementById('container-progress');
        av.innerHTML = ''; pr.innerHTML = '';
        orders.forEach(o => {
          const isMine = o.assigned === session.name;
          const isLocked = o.assigned && !isMine;
          const cardId = `card-${o.rowIndex}`;
          let btn = isMine ? `<button class="btn btn-success w-100" onclick="preFinish(${o.rowIndex}, '${o.order}')">FINISH & QC</button>` : 
                    isLocked ? `<button class="btn btn-secondary w-100" disabled>LOCKED BY ${o.assigned}</button>` : 
                    `<button class="btn btn-primary w-100" onclick="preStart(${o.rowIndex}, '${o.order}')">START</button>`;
          
          const html = `<div class="card mb-3 animate-card" id="${cardId}"><div class="status-bar ${isMine?'bar-running':(isLocked?'bar-locked':'bar-ready')}"></div><div class="card-body"><div class="d-flex justify-content-between mb-2"><h4>${o.order}</h4><span class="badge bg-dark">${o.status}</span></div>${btn}</div></div>`;
          isMine ? pr.innerHTML += html : av.innerHTML += html;
        });
      }).getOrdersForRole(session.role);
    }
    
    // OPTIMISTIC START
    function preStart(row, ord) { session.pendingRow = row; session.activeOrder = ord; document.getElementById('startModalOrder').innerText = ord; startModal.show(); }
    
    function confirmStart() {
      startModal.hide();
      // UI Update Immediate
      const card = document.getElementById(`card-${session.pendingRow}`);
      if(card) {
        card.querySelector('.status-bar').className = 'status-bar bar-running';
        card.querySelector('button').parentNode.innerHTML = `<button class="btn btn-success w-100" disabled>SYNCING...</button>`;
        document.getElementById('container-progress').appendChild(card);
        new bootstrap.Tab(document.querySelector('#dashTabs button[data-bs-target="#pane-progress"]')).show();
      }
      google.script.run.withSuccessHandler(res => { 
        session.logId = res.logId; 
        // Silent refresh to confirm state
        loadDashboard(true); 
      }).startOrder(session.pendingRow, session.name, session.role);
    }
    
    function preFinish(row, ord) { 
      session.pendingRow = row; session.activeOrder = ord; 
      if(session.role === 'Grinding') { if(confirm("Finish Grinding?")) submitQC(true); return; }
      
      // Build Full QC Checklist
      const qs = QC_DATA[session.role] || QC_DATA['Quality Control'];
      let h = ''; 
      qs.forEach((q,i) => {
        h += `<div class="mb-3 border-bottom pb-2"><div class="fw-bold mb-1">${q}</div><div class="btn-group w-100" role="group"><input type="radio" class="btn-check" name="q${i}" id="q${i}y" value="Y" autocomplete="off"><label class="btn btn-outline-success" for="q${i}y">YES</label><input type="radio" class="btn-check" name="q${i}" id="q${i}n" value="N" autocomplete="off"><label class="btn btn-outline-danger" for="q${i}n">NO</label></div></div>`;
      });
      document.getElementById('qcChecklistContainer').innerHTML = h;
      document.getElementById('qcOrderNum').innerText = ord; clearSignature(); qcModal.show();
    }

    function submitQC(skip=false) {
      let d = [], sig = '';
      if(!skip) {
        const qs = QC_DATA[session.role] || QC_DATA['Quality Control'];
        let allAnswered = true;
        qs.forEach((q,i) => { 
          const el = document.querySelector(`input[name="q${i}"]:checked`); 
          if(!el) allAnswered=false; 
          else d.push({q:q, a:el.value}); 
        });
        if(!allAnswered) { alert("Please answer all questions."); return; }
        sig = canvas.toDataURL();
      }
      qcModal.hide();
      
      // Optimistic Remove
      const card = document.getElementById(`card-${session.pendingRow}`);
      if(card) { card.style.opacity='0.5'; setTimeout(()=>card.remove(), 500); }
      
      google.script.run.withSuccessHandler(() => loadDashboard(true)).finishOrder(session.pendingRow, session.logId, d, sig);
    }

    // --- ADMIN VIEWS ---
    function loadProductionOverview() {
      navTo('view-admin-prod');
      document.getElementById('prodOverviewContent').innerHTML = '<div class="spinner-border"></div>';
      google.script.run.withSuccessHandler(data => {
        // Group by order
        const orderGroups = {};
        data.forEach(r => {
          if (!orderGroups[r.order]) orderGroups[r.order] = [];
          orderGroups[r.order].push(r);
        });
        
        let h = '<div class="accordion" id="prodAccordion">';
        
        Object.keys(orderGroups).sort().forEach((orderNum, idx) => {
          const tasks = orderGroups[orderNum];
          const totalDuration = tasks.reduce((sum, t) => sum + t.durationMins, 0);
          const totalHrs = (totalDuration / 60).toFixed(1);
          const isRunning = tasks.some(t => !t.end);
          
          h += `<div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button ${idx > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#order-${idx}">
                <div class="d-flex w-100 justify-content-between align-items-center pe-3">
                  <div><strong>${orderNum}</strong> <small class="text-muted">(${tasks.length} tasks)</small></div>
                  <div class="text-end">
                    ${isRunning ? '<span class="badge bg-success me-2">Running</span>' : ''}
                    <span class="badge bg-dark">${totalHrs} hrs</span>
                  </div>
                </div>
              </button>
            </h2>
            <div id="order-${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" data-bs-parent="#prodAccordion">
              <div class="accordion-body p-0">
                <div class="table-responsive">
                  <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Worker</th>
                        <th>Task</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th class="text-end">Duration</th>
                        <th>QC Status</th>
                      </tr>
                    </thead>
                    <tbody>`;
          
          tasks.forEach(r => {
            const s = r.start ? new Date(r.start).toLocaleString('en-ZA', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'}) : '-';
            const e = r.end ? new Date(r.end).toLocaleString('en-ZA', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'}) : '';
            const endCell = r.end ? e : '<span class="badge bg-success">Running</span>';
            const hrs = (r.durationMins / 60).toFixed(1);
            const qcIcon = r.qc && r.qc !== 'Skipped' ? '<i class="bi bi-check-circle-fill text-success" title="QC Complete"></i>' : '<i class="bi bi-dash-circle text-muted" title="No QC"></i>';
            
            h += `<tr>
              <td><strong>${r.worker}</strong></td>
              <td><span class="badge bg-secondary">${r.task}</span></td>
              <td>${s}</td>
              <td>${endCell}</td>
              <td class="text-end">${hrs} hrs</td>
              <td>${qcIcon}</td>
            </tr>`;
          });
          
          h += `    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>`;
        });
        
        h += '</div>';
        document.getElementById('prodOverviewContent').innerHTML = h;
      }).getProductionOverview();
    }

    function loadWorkerStats() {
      navTo('view-admin-workers');
      document.getElementById('workerSelect_List').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
      google.script.run.withSuccessHandler(workers => {
        appData.workerStats = workers;
        let h = '';
        Object.keys(workers).sort().forEach(name => {
          const totalHrs = (workers[name].totalMins / 60).toFixed(1);
          h += `<button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="showWorkerDetail('${name}')">
            <span><i class="bi bi-person-circle me-2"></i>${name}</span>
            <span class="badge bg-dark rounded-pill">${totalHrs} hrs</span>
          </button>`;
        });
        document.getElementById('workerSelect_List').innerHTML = h;
      }).getWorkerStats();
    }

    function showWorkerDetail(name) {
      const w = appData.workerStats[name];
      
      // Header with total time
      let h = `<div class="mb-4 pb-3 border-bottom">
        <h4 class="brand-font mb-2">${name}</h4>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h6 class="text-muted text-uppercase small mb-1">Total Hours</h6>
                <h2 class="mb-0 text-primary">${(w.totalMins/60).toFixed(1)}</h2>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h6 class="text-muted text-uppercase small mb-1">Total Tasks</h6>
                <h2 class="mb-0 text-dark">${w.logs.length}</h2>
              </div>
            </div>
          </div>
        </div>
      </div>`;
      
      // Weekly breakdown
      const weeks = Object.keys(w.weeklyMins).sort().reverse();
      if (weeks.length > 0) {
        h += '<div class="mb-4"><h5 class="brand-font mb-3">Weekly Breakdown</h5>';
        h += '<div class="table-responsive"><table class="table table-sm table-hover">';
        h += '<thead class="table-dark"><tr><th>Week</th><th class="text-end">Hours</th></tr></thead><tbody>';
        weeks.forEach(week => {
          const hrs = (w.weeklyMins[week]/60).toFixed(1);
          h += `<tr><td><strong>${week}</strong></td><td class="text-end">${hrs} hrs</td></tr>`;
        });
        h += '</tbody></table></div></div>';
      }
      
      // Detailed work log
      h += '<div class="mb-3"><h5 class="brand-font mb-3">Detailed Work Log</h5>';
      h += '<div class="table-responsive"><table class="table table-striped table-sm">';
      h += '<thead class="table-light"><tr><th>Date</th><th>Order</th><th>Task</th><th>Start</th><th>End</th><th class="text-end">Duration</th></tr></thead><tbody>';
      
      // Sort logs by start time (most recent first)
      const sortedLogs = [...w.logs].sort((a, b) => (b.start || 0) - (a.start || 0));
      
      sortedLogs.forEach(l => {
        const date = l.start ? new Date(l.start).toLocaleDateString('en-ZA', {year: 'numeric', month: 'short', day: 'numeric'}) : '-';
        const startTime = l.start ? new Date(l.start).toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'}) : '-';
        const endTime = l.end ? new Date(l.end).toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'}) : '';
        const endCell = l.end ? endTime : '<span class="badge bg-success">Running</span>';
        const hrs = (l.duration / 60).toFixed(1);
        h += `<tr>
          <td>${date}</td>
          <td><strong>${l.order}</strong></td>
          <td><span class="badge bg-secondary">${l.task}</span></td>
          <td>${startTime}</td>
          <td>${endCell}</td>
          <td class="text-end">${hrs} hrs</td>
        </tr>`;
      });
      
      h += '</tbody></table></div></div>';
      document.getElementById('workerDetailContent').innerHTML = h;
    }

    // Sig Pad
    function initSigPad() {
      canvas = document.getElementById('sigCanvas'); ctx = canvas.getContext('2d');
      ctx.lineWidth=2; canvas.addEventListener('mousedown', sD); canvas.addEventListener('mousemove', dD); canvas.addEventListener('mouseup', () => isDrawing=false);
      canvas.addEventListener('touchstart', e=>{e.preventDefault();sD(e.touches[0])}); canvas.addEventListener('touchmove', e=>{e.preventDefault();dD(e.touches[0])});
    }
    function sD(e) { isDrawing=true; const r=canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(e.clientX-r.left, e.clientY-r.top); }
    function dD(e) { if(!isDrawing)return; const r=canvas.getBoundingClientRect(); ctx.lineTo(e.clientX-r.left, e.clientY-r.top); ctx.stroke(); }
    function clearSignature() { ctx.clearRect(0,0,canvas.width,canvas.height); }
  </script>
</body>
</html>
