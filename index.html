<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Studio Delta</title>
  
  <!-- Fonts & Bootstrap -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    :root { --sd-bg: #EBEAE6; --sd-text: #1a1a1a; --sd-accent: #000000; --sd-white: #ffffff; }
    body { background-color: var(--sd-bg); color: var(--sd-text); font-family: 'Lato', sans-serif; overflow-x: hidden; }
    h1, h2, h3, h4, h5, .brand-font { font-family: 'Playfair Display', serif; color: var(--sd-accent); }
    
/* SIDEBAR */
    .sidebar { 
        position: fixed; 
        top: 0; 
        left: 0; 
        height: 100vh; 
        width: 260px; 
        background: white; 
        z-index: 1100; /* Increased to sit ABOVE the mobile header */
        transform: translateX(-100%); 
        transition: transform 0.3s ease; 
        box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
        padding-top: 20px; /* Reset padding, button handles spacing now */
    }
    .sidebar.active { transform: translateX(0); }

    /* RESTORED LINK STYLING */
    .sidebar-link { 
        display: block; 
        padding: 15px 25px; 
        color: #333; 
        text-decoration: none; 
        font-weight: bold; 
        border-left: 4px solid transparent; 
        cursor: pointer; 
        transition: all 0.2s;
    }
    .sidebar-link:hover { background-color: #f0f0f0; }
    .sidebar-link.active { background: #f8f9fa; border-left-color: black; }

    /* MENU BUTTON */
    .menu-toggle { 
        position: fixed; 
        top: 20px; 
        left: 25px; 
        z-index: 1200; /* Highest priority */
        background: white; 
        border: none; 
        padding: 10px 14px; 
        border-radius: 50%; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        transition: left 0.3s ease, background 0.3s ease, transform 0.2s; /* Animate movement */
    }

    .menu-toggle:hover { transform: scale(1.1); background: #f8f9fa; }

    /* WHEN MENU IS OPEN - MOVE BUTTON RIGHT */
    .menu-toggle.active {
        left: 205px !important; /* Moves inside the sidebar (260px width) */
        background: transparent; /* Blends into sidebar */
        box-shadow: none; 
    }

    /* MOBILE ONLY FIXES */
    @media (max-width: 768px) {
        /* Glass Header */
        body::before {
            content: '';
            position: fixed; top: 0; left: 0; width: 100%; height: 65px; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(5px); 
            z-index: 1050; 
            border-bottom: 1px solid #e0e0e0;
            display: block;
        }

        /* Default Mobile Button Position */
        .menu-toggle {
            top: 10px;
            left: 15px;
            box-shadow: none; 
            background: transparent; 
        }

        /* Content spacing */
        .container-fluid { padding-top: 90px !important; }
    }

    @media (min-width: 769px) {
        body::before { display: none; }
    }
    
    /* BUTTONS */
    .btn-primary, .btn-primary:hover, .btn-primary:active, .btn-primary:focus {
        background-color: #000000 !important;
        border-color: #000000 !important;
        color: #ffffff !important;
    }
    .btn-outline-dark, .btn-outline-dark:hover {
        border-color: #000000 !important;
        color: #000000 !important;
    }
    .nav-pills .nav-link.active { background-color: #000000 !important; color: white !important; }
    .nav-pills .nav-link { color: #555 !important; font-weight: bold; }

    /* DASHBOARD */
    .status-bar { height: 4px; width: 100%; }
    .bar-ready { background-color: #000; } 
    .bar-running { background-color: #198754; } 
    .bar-locked { background-color: #dc3545; }
    .d-none-view { display: none !important; }
    #sigCanvas { border: 1px solid #ccc; width: 100%; height: 200px; touch-action: none; background-color: white; }
    
    .live-timer { font-variant-numeric: tabular-nums; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-card { animation: slideIn 0.3s ease-out forwards; }
  </style>
</head>
<body>

  <!-- LOADER -->
  <div id="loader" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex flex-column justify-content-center align-items-center" style="z-index:9999;">
    <h2 class="brand-font mb-3">STUDIO DELTA</h2>
    <div class="spinner-border text-dark"></div>
  </div>

  <!-- NAVIGATION -->
  <button class="menu-toggle" onclick="toggleSidebar()"><i class="bi bi-list fs-4"></i></button>

  <div class="sidebar" id="sidebar">
    <div class="px-4 mb-4 mt-5"><h4 class="brand-font">MENU</h4></div>
    <a id="link-roles" class="sidebar-link active" onclick="navTo('view-roles')">Home / Roles</a>
    <div id="adminLinks" class="d-none-view">
      <a id="link-prod" class="sidebar-link" onclick="loadProductionOverview()">Production Overview</a>
      <a id="link-work" class="sidebar-link" onclick="loadWorkerStats()">Worker Information</a>
    </div>
    <div class="mt-auto px-4 pt-5"><button class="btn btn-outline-danger w-100" onclick="logout()">Log Out</button></div>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- MAIN CONTENT -->
  <div class="container-fluid py-5" style="padding-top: 80px;">
    
    <!-- VIEW: ROLE SELECTION -->
    <div id="view-roles" class="view-section container">
      <div class="text-center mb-5"><h1 class="display-4 fw-bold">Studio Delta</h1><p class="text-muted small text-uppercase">Production Management System</p></div>
      <div class="row g-3" id="roleGrid"></div>
    </div>

    <!-- VIEW: USER SELECTION -->
    <div id="view-users" class="view-section container d-none-view">
      <button class="btn btn-outline-dark mb-4" onclick="navTo('view-roles')">&larr; BACK</button>
      <h2 class="mb-4"><span id="selectedRoleTitle"></span> Team</h2>
      <div class="list-group list-group-flush bg-white rounded shadow-sm" id="userList"></div>
    </div>

    <!-- VIEW: WORKER DASHBOARD -->
    <div id="view-dashboard" class="view-section container d-none-view">
      <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
        <div><h4 class="m-0" id="dashUser">User</h4><small class="text-muted text-uppercase" id="dashRole">Role</small></div>
      </div>
      
      <input type="text" id="dashSearch" class="form-control mb-3" placeholder="Search Order #" onkeyup="filterDashboard()">

      <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded shadow-sm" id="dashTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pane-available">Available</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-progress">In Progress</button></li>
      </ul>
      <div class="text-end mb-2"><button class="btn btn-sm btn-link text-muted text-decoration-none" onclick="loadDashboard()"><i class="bi bi-arrow-clockwise"></i> Refresh</button></div>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="pane-available"><div id="container-available"></div></div>
        <div class="tab-pane fade" id="pane-progress"><div id="container-progress"></div></div>
      </div>
    </div>

    <!-- VIEW: ADMIN OVERVIEW -->
    <div id="view-admin-prod" class="view-section container d-none-view">
      <h2 class="brand-font mb-4">Production Overview</h2>
      
      <input type="text" id="prodSearch" class="form-control mb-3" placeholder="Search Order #" onkeyup="filterProduction()">

      <ul class="nav nav-pills mb-3" id="adminProdTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-notstarted">Not Started</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-production">In Production</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-delivery">Out for Delivery</button></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-notstarted"><div id="list-notstarted"></div></div>
        <div class="tab-pane fade" id="tab-production"><div id="list-production"></div></div>
        <div class="tab-pane fade" id="tab-delivery"><div id="list-delivery"></div></div>
      </div>
    </div>

    <!-- VIEW: ADMIN WORKER STATS -->
    <div id="view-admin-workers" class="view-section container d-none-view">
      <h2 class="brand-font mb-4">Worker Information</h2>
      <div class="row">
        <div class="col-md-4 mb-3"><div class="list-group" id="workerSelect_List"></div></div>
        <div class="col-md-8"><div id="workerDetailContent" class="bg-white p-4 rounded shadow-sm"><p class="text-muted text-center">Select a worker.</p></div></div>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modal fade" id="passModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-4"><h3 class="mb-3">Access Code</h3><p class="text-muted" id="passPromptName">Enter code</p><input type="password" id="inputPass" class="form-control text-center mb-3"><button class="btn btn-primary w-100" onclick="submitPass()">ENTER</button></div></div></div>
  
  <div class="modal fade" id="startModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-4"><h3 class="brand-font mb-2">Start Order</h3><h1 class="fw-bold text-primary mb-3" id="startModalOrder">...</h1><button class="btn btn-primary btn-lg w-100 mt-3" onclick="confirmStart()">START TIMER</button></div></div></div>
  
  <div class="modal fade" id="qcModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title brand-font">Checklist</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><div class="mb-3"><strong>Order:</strong> <span id="qcOrderNum"></span></div><div id="qcChecklistContainer"></div><div class="mt-4"><label class="fw-bold">Signature</label><div class="border"><canvas id="sigCanvas"></canvas></div><button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearSignature()">Clear</button></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitQC()">CONFIRM</button></div></div></div></div>
  
  <div class="modal fade" id="alertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center p-4"><h5 class="mb-3" id="alertMsg"></h5><button class="btn btn-primary px-4" data-bs-dismiss="modal">OK</button></div></div></div></div>
  
  <div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center p-4"><h5 class="mb-3" id="confirmMsg"></h5><div class="d-flex justify-content-center gap-2"><button class="btn btn-primary px-4" id="confirmBtnYes">YES</button><button class="btn btn-outline-dark px-4" data-bs-dismiss="modal">NO</button></div></div></div></div></div>

  <!-- JAVASCRIPT -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- APP DATA ---
    let appData = { users: [], workerStats: {} };
    let session = { role: null, name: null, pendingRow: null, activeOrder: null, logId: null, isAdmin: false };
    let refreshInterval = null;
    let liveTimerInterval = null;
    let hasSigned = false;
    let confirmCallback = null;
    let isSubmitting = false; 

    // --- QC QUESTIONS CONFIG ---
    // Ensure keys match roles exactly
    const QC_DATA = {
      'Cutting': ["Does the overall dimensions of the cutting list match the Job Card?", "Are all the items on the cutting list cut?", "Are items cut exactly to size according to the cutting list?", "Have all the angles been cut where indicated?"],
      'Tagging': ["Have you read the description on the Job Card?", "Is there a drawing?", "Does the drawing match the description?", "If the drawing did not match, did you notify your supervisor?", "Was mistakes corrected?", "Does the measurements of the cut lengths match the cutting list and drawing?", "Is the frame square after tagging it?", "Are the dimensions of the frame the same as on the Job Card?", "Does the standard glass dimensions fit?", "If the unit is custom, did you measure the custom glass sizes?", "Did you indicate on the job card the custom glass dimensions?"],
      'Welding': ["Have you read the description on the Job Card?", "Is there a drawing?", "Does the drawing match the description?", "If the drawing did not match, did you notify your supervisor?", "Were mistakes corrected?", "Does the measurements of the cut lengths match the cutting list and drawing?", "Is the frame square after tagging it?", "Are the dimensions of the frame the same as on the Job Card?", "Does the standard glass dimensions fit?", "Have all the tag spots been welded?", "Have all plates been bent and welded in place?", "Are the plates flush, free from dents and scratches?", "Will the standard glass dimensions fit?", "If there are custom glass dimensions, will it fit?", "Is the frame still square?", "Is your name on the Job Card?"],
      'Grinding': ["Have all welds been ground flush?", "Are there any deep scratches?", "Is the surface smooth ready for coating?"],
      'Quality Control': ["Did you read the description on the job card?", "Is there a drawing?", "Does the item match the drawing?", "Does the colour of the item match the description?", "Do you have the top plate for the unit?", "Are there dents on the top plate or scratch marks?", "Is the paint free of defects and scratches?", "Did you report issues with the paint to your supervisor?", "Is the frame square?", "Did you check if the glass fits before putting it in?", "Did you clean the glass before putting it in?"],
      'Assembly': ["Did you cut and paint the backboard before fitting the glass?", "Did you fit the glass and make sure the glass clips align?", "Did you fit the handles, magnets and End Caps?", "Are the magnets and handles aligned and free of scratches?", "Did you fit the back board and make sure the screws are hidden?", "Did you wipe down the unit and remove excess silicon?", "Did you place rubber bumpers on the glass shelves and magnets?", "Did you level the unit for QC?", "Did you notify the cleaner that the unit is ready to be cleaned?"]
    };

    let passModal, startModal, qcModal, alertModal, confirmModal, canvas, ctx, isDrawing = false;

    document.addEventListener('DOMContentLoaded', () => {
      // Init Bootstrap Modals
      passModal = new bootstrap.Modal('#passModal');
      startModal = new bootstrap.Modal('#startModal');
      qcModal = new bootstrap.Modal('#qcModal');
      alertModal = new bootstrap.Modal('#alertModal');
      confirmModal = new bootstrap.Modal('#confirmModal');
      
      initSigPad();
      initApp();
      startLiveTimers();
      
      document.getElementById('confirmBtnYes').onclick = () => { confirmModal.hide(); if(confirmCallback) confirmCallback(); };
    });

    // --- UI HELPERS ---
    function showAlert(msg) { document.getElementById('alertMsg').innerText = msg; alertModal.show(); }
    function showConfirm(msg, cb) { document.getElementById('confirmMsg').innerText = msg; confirmCallback = cb; confirmModal.show(); }
    function toggleSidebar() { 
        document.getElementById('sidebar').classList.toggle('active'); 
        document.getElementById('sidebarOverlay').classList.toggle('active');
        
        // This line makes the button slide with the menu
        document.querySelector('.menu-toggle').classList.toggle('active'); 
    }
    
    function navTo(viewId) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none-view'));
      document.getElementById(viewId).classList.remove('d-none-view');
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
      
      let linkId = '';
      if(viewId.includes('roles') || viewId.includes('users') || viewId.includes('dashboard')) linkId = 'link-roles';
      if(viewId.includes('prod')) linkId = 'link-prod';
      if(viewId.includes('workers')) linkId = 'link-work';
      
      const linkEl = document.getElementById(linkId); if(linkEl) linkEl.classList.add('active');
      
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('sidebarOverlay').classList.remove('active');
      
      if(viewId !== 'view-dashboard') stopAutoRefresh();
    }

    // --- INITIALIZATION ---
    function initApp() {
      google.script.run.withSuccessHandler(data => {
        appData.users = data; 
        renderRoles(); 
        document.getElementById('loader').classList.add('d-none');
      }).getUsersAndRoles();
    }

    function renderRoles() {
      const grid = document.getElementById('roleGrid'); 
      grid.innerHTML = '';
      const roles = [...new Set(appData.users.map(u => u.role))].sort();
      roles.forEach(r => {
        grid.innerHTML += `<div class="col-md-4"><div class="card p-4 text-center h-100 role-card" onclick="selectRole('${r}')"><h4>${r}</h4></div></div>`;
      });
    }

    function selectRole(r) { 
      session.role = r; 
      if(r.toLowerCase() === 'admin') promptPass('Admin'); 
      else renderUsers(r); 
    }

    function renderUsers(r) {
      const list = document.getElementById('userList'); 
      document.getElementById('selectedRoleTitle').innerText = r; 
      list.innerHTML = '';
      appData.users.filter(u => u.role === r).forEach(u => {
        list.innerHTML += `<button class="list-group-item list-group-item-action py-3 fw-bold" onclick="promptPass('${u.name}')">${u.name}</button>`;
      });
      navTo('view-users');
    }

    function promptPass(n) { 
      session.name = n; 
      document.getElementById('passPromptName').innerText = "Code for " + n; 
      document.getElementById('inputPass').value=''; 
      passModal.show(); 
    }

    function submitPass() {
      const p = document.getElementById('inputPass').value;
      google.script.run.withSuccessHandler(res => {
        if(res.success) { 
          session.isAdmin = res.isAdmin; 
          passModal.hide(); 
          if(session.role === 'Admin') {
            document.getElementById('adminLinks').classList.remove('d-none-view');
            loadProductionOverview();
          } else {
            document.getElementById('adminLinks').classList.add('d-none-view');
            enterDashboard();
          }
        } else {
          showAlert(res.error);
        }
      }).verifyLogin(session.role, session.name, p);
    }
    
    function logout() { 
      session = {}; 
      document.getElementById('adminLinks').classList.add('d-none-view'); 
      navTo('view-roles'); 
    }

    // --- FILTERING ---
    function filterDashboard() {
      const q = document.getElementById('dashSearch').value.toLowerCase();
      document.querySelectorAll('#view-dashboard .card').forEach(c => {
        const txt = c.querySelector('h4').innerText.toLowerCase();
        c.style.display = txt.includes(q) ? '' : 'none';
      });
    }
    function filterProduction() {
      const q = document.getElementById('prodSearch').value.toLowerCase();
      document.querySelectorAll('#view-admin-prod .card').forEach(c => {
        const txt = c.querySelector('button div strong').innerText.toLowerCase();
        c.style.display = txt.includes(q) ? '' : 'none';
      });
    }
    function filterWorkerLogs() {
      const q = document.getElementById('workerLogSearch').value.toLowerCase();
      document.querySelectorAll('#workerLogTable tbody tr').forEach(row => {
        const txt = row.cells[1].innerText.toLowerCase();
        row.style.display = txt.includes(q) ? '' : 'none';
      });
    }

    // --- DASHBOARD LOGIC ---
    function enterDashboard() {
      navTo('view-dashboard');
      document.getElementById('dashUser').innerText = session.name;
      document.getElementById('dashRole').innerText = session.role;
      const tabEl = document.querySelector('#dashTabs button[data-bs-target="#pane-available"]');
      if(tabEl) new bootstrap.Tab(tabEl).show();
      loadDashboard(false);
      startAutoRefresh();
    }
    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(() => { if (!document.querySelector('.modal.show')) loadDashboard(true); }, 30000); 
    }
    function stopAutoRefresh() { if (refreshInterval) clearInterval(refreshInterval); }

    function loadDashboard(silent = false) {
      if(!silent) document.getElementById('container-available').innerHTML = '<div class="spinner-border"></div>';
      
      google.script.run.withSuccessHandler(orders => {
        const av = document.getElementById('container-available'); 
        const pr = document.getElementById('container-progress');
        av.innerHTML = ''; pr.innerHTML = '';
        
        orders.forEach(o => {
          const isMine = o.assigned === session.name;
          const isLocked = o.assigned && !isMine;
          const cardId = `card-${o.rowIndex}`;
          let btn = '';
          
          if (session.isAdmin) {
             btn = `<button class="btn btn-secondary w-100" disabled><i class="bi bi-eye-fill"></i> ADMIN VIEW ONLY</button>`;
          } else {
             if(isMine) {
               btn = `<button class="btn btn-success w-100" onclick="preFinish(${o.rowIndex}, '${o.order}')">FINISH & QC</button>`;
             } else if(isLocked) {
               btn = `<button class="btn btn-secondary w-100" disabled>LOCKED BY ${o.assigned}</button>`;
             } else {
               btn = `<button class="btn btn-primary w-100" onclick="preStart(${o.rowIndex}, '${o.order}')">START</button>`;
             }
          }

          const html = `<div class="card mb-3 animate-card" id="${cardId}"><div class="status-bar ${isMine?'bar-running':(isLocked?'bar-locked':'bar-ready')}"></div><div class="card-body"><div class="d-flex justify-content-between mb-2"><h4>${o.order}</h4><span class="badge bg-dark">${o.status}</span></div>${btn}</div></div>`;
          
          if(isMine) pr.innerHTML += html; else av.innerHTML += html;
        });
        filterDashboard(); 
      }).getOrdersForRole(session.role);
    }
    
    // --- ACTIONS ---
    function preStart(row, ord) { 
      session.pendingRow = row; 
      session.activeOrder = ord; 
      document.getElementById('startModalOrder').innerText = ord; 
      startModal.show(); 
    }
    
    function confirmStart() {
      if (isSubmitting) return; 
      isSubmitting = true;
      startModal.hide();
      
      const card = document.getElementById(`card-${session.pendingRow}`);
      if(card) {
        card.querySelector('.status-bar').className = 'status-bar bar-running';
        card.querySelector('button').parentNode.innerHTML = `<button class="btn btn-success w-100" disabled>SYNCING...</button>`;
        document.getElementById('container-progress').appendChild(card);
        new bootstrap.Tab(document.querySelector('#dashTabs button[data-bs-target="#pane-progress"]')).show();
      }
      
      // Pass OrderNumber for verification
      google.script.run.withSuccessHandler(res => { 
        isSubmitting = false;
        if(res.success) {
           session.logId = res.logId; 
           loadDashboard(true);
        } else {
           showAlert(res.message || "Error starting order");
           loadDashboard();
        }
      }).withFailureHandler(err => { 
        isSubmitting=false; 
        showAlert("Error: "+err); 
        loadDashboard(); 
      }).startOrder(session.pendingRow, session.activeOrder, session.name, session.role);
    }
    
    function preFinish(row, ord) { 
      session.pendingRow = row; 
      session.activeOrder = ord; 
      
      // Get QC Questions
      const qs = QC_DATA[session.role];
      
      // If role has no specific QC, we can skip or show confirm
      if (!qs || qs.length === 0) {
        showConfirm("Finish Order " + ord + "?", () => submitQC(true));
        return;
      }

      let h = ''; 
      qs.forEach((q,i) => {
        h += `<div class="mb-3 border-bottom pb-2"><div class="fw-bold mb-1">${q}</div><div class="btn-group w-100" role="group"><input type="radio" class="btn-check" name="q${i}" id="q${i}y" value="Y" autocomplete="off"><label class="btn btn-outline-success" for="q${i}y">YES</label><input type="radio" class="btn-check" name="q${i}" id="q${i}n" value="N" autocomplete="off"><label class="btn btn-outline-danger" for="q${i}n">NO</label></div></div>`;
      });
      document.getElementById('qcChecklistContainer').innerHTML = h;
      document.getElementById('qcOrderNum').innerText = ord; 
      clearSignature(); 
      qcModal.show();
    }

    function submitQC(skip=false) {
      if(isSubmitting) return;
      let d = [], sig = '';
      
      if(!skip) {
        const qs = QC_DATA[session.role];
        let allAnswered = true;
        
        if (qs) {
            qs.forEach((q,i) => { 
                const el = document.querySelector(`input[name="q${i}"]:checked`); 
                if(!el) allAnswered=false; 
                else d.push({q:q, a:el.value}); 
            });
            if(!allAnswered) { showAlert("Please answer all questions."); return; }
            if(!hasSigned) { showAlert("Please sign before confirming."); return; } 
            sig = canvas.toDataURL();
        }
      }
      
      isSubmitting = true;
      qcModal.hide();
      
      // Optimistic UI update
      const card = document.getElementById(`card-${session.pendingRow}`);
      if(card) { card.style.opacity='0.5'; setTimeout(()=>card.remove(), 500); }
      
      google.script.run.withSuccessHandler(() => { 
        isSubmitting=false; 
        loadDashboard(true); 
      }).finishOrder(session.pendingRow, session.activeOrder, session.logId, d, sig);
    }

    // --- TIME CALCULATION (Client Side Display Only) ---
    function calculateWorkMinutes(startTs, endTs, taskName) {
      if (!startTs) return 0;
      let start = new Date(parseInt(startTs));
      let end = endTs ? new Date(parseInt(endTs)) : new Date();
      let totalMinutes = 0;
      let current = new Date(start.getTime());
      
      if (taskName && taskName.toLowerCase().includes('powder')) {
        return (end - start) / 1000 / 60;
      }

      let safety = 0;
      while (current < end && safety < 500) { 
        safety++;
        let day = current.getDay();
        if (day === 0 || day === 6) {
          current.setDate(current.getDate() + 1);
          current.setHours(7, 30, 0, 0);
          continue;
        }
        let shiftStart = new Date(current); shiftStart.setHours(7, 30, 0, 0);
        let shiftEnd = new Date(current); shiftEnd.setHours(15, 45, 0, 0);
        
        let windowStart = (current > shiftStart) ? current : shiftStart;
        let windowEnd = (end < shiftEnd) ? end : shiftEnd;
        
        if (windowStart < windowEnd) {
          totalMinutes += (windowEnd - windowStart) / 1000 / 60;
        }
        if (end < shiftEnd) break; 
        else { 
            current.setDate(current.getDate() + 1); 
            current.setHours(7, 30, 0, 0); 
        }
      }
      return Math.floor(totalMinutes);
    }

    function formatDuration(totalMins) {
      let h = Math.floor(totalMins / 60);
      let m = Math.floor(totalMins % 60);
      return (h < 10 ? "0"+h : h) + ":" + (m < 10 ? "0"+m : m);
    }

    function startLiveTimers() {
      if(liveTimerInterval) clearInterval(liveTimerInterval);
      liveTimerInterval = setInterval(() => {
        document.querySelectorAll('.live-timer').forEach(el => {
          const start = el.getAttribute('data-start');
          const task = el.getAttribute('data-task');
          if(start) {
            const mins = calculateWorkMinutes(start, null, task);
            el.innerText = formatDuration(mins);
          }
        });
      }, 1000); 
    }

    // --- ADMIN VIEWS ---
    function loadProductionOverview() {
      navTo('view-admin-prod');
      const tabEl = document.querySelector('#adminProdTabs button[data-bs-target="#tab-notstarted"]');
      if(tabEl) new bootstrap.Tab(tabEl).show();

      document.getElementById('list-notstarted').innerHTML = '<div class="spinner-border"></div>';
      document.getElementById('list-production').innerHTML = '<div class="spinner-border"></div>';
      document.getElementById('list-delivery').innerHTML = '<div class="spinner-border"></div>';

      google.script.run.withSuccessHandler(data => {
        const rawLogs = data.logs;
        const allOrders = data.orders;
        const orderLogs = {};
        
        rawLogs.forEach(r => {
          if (!orderLogs[r.order]) orderLogs[r.order] = [];
          r.durationMins = calculateWorkMinutes(r.start, r.end, r.task);
          orderLogs[r.order].push(r);
        });

        let htmlNotStarted = '<div class="accordion">';
        let htmlProd = '<div class="accordion">';
        let htmlDeliv = '<div class="accordion">';

        allOrders.forEach((o, i) => {
          const status = String(o.status).toLowerCase();
          const tasks = orderLogs[o.order] || [];
          const totalDuration = tasks.reduce((sum, t) => sum + t.durationMins, 0);
          const totalTimeStr = formatDuration(totalDuration);
          const isRunning = tasks.some(t => !t.end);
          
          let item = `<div class="card mb-2 shadow-sm"><div class="card-header bg-white"><button class="btn btn-link text-decoration-none text-dark w-100 text-start d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#ord-${i}"><div><strong>${o.order}</strong> <span class="badge bg-light text-dark border ms-2">${o.status}</span></div><div>${isRunning ? '<span class="badge bg-success me-2">Active</span>' : ''}<span class="badge bg-dark">${totalTimeStr}</span></div></button></div><div id="ord-${i}" class="collapse"><div class="card-body p-0"><div class="table-responsive"><table class="table table-sm mb-0"><thead><tr><th>Worker</th><th>Task</th><th>Start</th><th>End</th><th>Duration</th><th>QC</th></tr></thead><tbody>`;
          
          if(tasks.length === 0) {
            item += `<tr><td colspan="6" class="text-center text-muted py-3">No activity recorded yet.</td></tr>`;
          } else {
            tasks.forEach(t => {
              const startDisplay = t.start ? new Date(t.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '-';
              const endDisplay = t.end ? new Date(t.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '-';
              let durDisplay = formatDuration(t.durationMins);
              if(!t.end) durDisplay = `<span class="badge bg-success live-timer" data-start="${t.start}" data-task="${t.task}">${durDisplay}</span>`;
              const qcIcon = t.qc && t.qc !== 'Skipped' ? '<i class="bi bi-check-circle-fill text-success"></i>' : '-';
              item += `<tr><td>${t.worker}</td><td>${t.task}</td><td>${startDisplay}</td><td>${endDisplay}</td><td>${durDisplay}</td><td>${qcIcon}</td></tr>`;
            });
          }
          item += `</tbody></table></div></div></div></div>`;

          if (status.startsWith('not yet started')) htmlNotStarted += item;
          else if (status.startsWith('out for') || status.startsWith('delivered')) htmlDeliv += item;
          else htmlProd += item;
        });

        htmlNotStarted += '</div>'; htmlProd += '</div>'; htmlDeliv += '</div>';
        document.getElementById('list-notstarted').innerHTML = htmlNotStarted || '<p class="text-muted">Empty</p>';
        document.getElementById('list-production').innerHTML = htmlProd || '<p class="text-muted">Empty</p>';
        document.getElementById('list-delivery').innerHTML = htmlDeliv || '<p class="text-muted">Empty</p>';
        filterProduction(); 
      }).getAdminDashboardData();
    }

    function loadWorkerStats() {
      navTo('view-admin-workers');
      document.getElementById('workerSelect_List').innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
      
      google.script.run.withSuccessHandler(data => {
        const rawLogs = data.logs;
        appData.workerStats = {};
        
        rawLogs.forEach(r => {
          if(!r.worker) return;
          if(!appData.workerStats[r.worker]) appData.workerStats[r.worker] = { totalMins: 0, logs: [] };
          const dur = calculateWorkMinutes(r.start, r.end, r.task);
          appData.workerStats[r.worker].totalMins += dur;
          r.durationMins = dur;
          appData.workerStats[r.worker].logs.push(r);
        });
        
        let h = '';
        Object.keys(appData.workerStats).sort().forEach(name => {
          const w = appData.workerStats[name];
          h += `<button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="showWorkerDetail('${name}')"><span><i class="bi bi-person-circle me-2"></i>${name}</span><span class="badge bg-dark rounded-pill">${formatDuration(w.totalMins)}</span></button>`;
        });
        document.getElementById('workerSelect_List').innerHTML = h;
      }).getAdminDashboardData();
    }

    function showWorkerDetail(name) {
      const w = appData.workerStats[name];
      let h = `<div class="mb-4 pb-3 border-bottom"><h4 class="brand-font mb-2">${name}</h4><div class="card bg-light"><div class="card-body text-center"><h6 class="text-muted text-uppercase small mb-1">Total Hours</h6><h2 class="mb-0 text-primary">${formatDuration(w.totalMins)}</h2></div></div></div>`;
      
      h += `<input type="text" id="workerLogSearch" class="form-control mb-3" placeholder="Search Order # in logs..." onkeyup="filterWorkerLogs()">`;
      
      h += '<div class="mb-3"><div class="table-responsive"><table class="table table-striped table-sm" id="workerLogTable"><thead class="table-light"><tr><th>Date</th><th>Order</th><th>Task</th><th>Start</th><th>End</th><th class="text-end">Duration</th></tr></thead><tbody>';
      
      w.logs.sort((a,b) => b.start - a.start).forEach(l => {
        const d = l.start ? new Date(l.start).toLocaleDateString() : '-';
        const s = l.start ? new Date(l.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '-';
        const e = l.end ? new Date(l.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '<span class="badge bg-success">Running</span>';
        
        let durDisplay = formatDuration(l.durationMins);
        if(!l.end) durDisplay = `<span class="badge bg-success live-timer" data-start="${l.start}" data-task="${l.task}">${durDisplay}</span>`;
        
        h += `<tr><td>${d}</td><td><strong>${l.order}</strong></td><td>${l.task}</td><td>${s}</td><td>${e}</td><td class="text-end">${durDisplay}</td></tr>`;
      });
      h += '</tbody></table></div></div>';
      document.getElementById('workerDetailContent').innerHTML = h;
    }

    // --- SIGNATURE PAD ---
    function initSigPad() {
      canvas = document.getElementById('sigCanvas'); 
      ctx = canvas.getContext('2d');
      ctx.lineWidth=2; 
      
      // Resize for retina/mobile
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      
      canvas.addEventListener('mousedown', sD); 
      canvas.addEventListener('mousemove', dD); 
      canvas.addEventListener('mouseup', () => isDrawing=false);
      
      canvas.addEventListener('touchstart', e=>{e.preventDefault();sD(e.touches[0])}, {passive: false}); 
      canvas.addEventListener('touchmove', e=>{e.preventDefault();dD(e.touches[0])}, {passive: false});
    }
    
    function sD(e) { 
        isDrawing=true; hasSigned=true; 
        const r=canvas.getBoundingClientRect(); 
        ctx.beginPath(); 
        ctx.moveTo(e.clientX-r.left, e.clientY-r.top); 
    }
    function dD(e) { 
        if(!isDrawing)return; 
        const r=canvas.getBoundingClientRect(); 
        ctx.lineTo(e.clientX-r.left, e.clientY-r.top); 
        ctx.stroke(); 
    }
    function clearSignature() { 
        hasSigned=false; 
        ctx.clearRect(0,0,canvas.width,canvas.height); 
    }
  </script>
</body>
</html>
